<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>AR com A-Frame e WebXR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
      html, body {
        margin: 0;
        overflow: hidden;
        background: transparent;
      }
      #loadingIndicator {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 24px;
        z-index: 9999;
      }
      #errorIndicator {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: red;
        color: white;
        padding: 10px;
        display: none;
        z-index: 10000;
      }
      #locationInfo {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        color: white;
        padding: 10px;
        z-index: 10002;
      }
      #startAR {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 10px 20px;
        font-size: 18px;
        background-color: #4CC3D9;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 10001;
      }
    </style>
  </head>
  <body>
    <div id="loadingIndicator">Carregando AR...</div>
    <div id="errorIndicator">Erro: Posição indefinida ou imagem ruim.</div>
    <div id="locationInfo">
      Latitude: <span id="lat">-</span><br>
      Longitude: <span id="lon">-</span><br>
      Distância: <span id="dist">-</span>m
    </div>
    
    <button id="startAR">Iniciar AR</button>

    <a-scene
      webxr="requiredFeatures: hit-test,local-floor;
             overlayElement: #overlay;
             optionalFeatures: dom-overlay,unbounded"
      embedded
      renderer="logarithmicDepthBuffer: true; precision: medium;"
      vr-mode-ui="enabled: false"
    >
      <!-- Sistema de iluminação -->
      <a-light type="ambient" intensity="0.5"></a-light>
      <a-light type="directional" intensity="0.8" position="-1 1 1"></a-light>

      <!-- Plano de referência -->
      <a-plane
        id="ground"
        position="0 0 0"
        rotation="-90 0 0"
        width="100"
        height="100"
        color="#7BC8A4"
        material="transparent: true; opacity: 0.5"
        class="cantap"
        visible="false">
      </a-plane>

      <!-- Objetos 3D -->
      <a-entity id="objects" position="0 0 -2">
        <a-box
          position="-1 0.5 0"
          rotation="0 45 0"
          color="#4CC3D9"
          shadow
          animation="property: rotation; to: 0 405 0; dur: 2000; easing: linear; loop: true">
        </a-box>

        <a-sphere
          position="0 1.25 0"
          radius="0.5"
          color="#EF2D5E"
          shadow
          animation="property: position; to: 0 1.75 0; dir: alternate; dur: 2000; easing: easeInOutQuad; loop: true">
        </a-sphere>

        <a-cylinder
          position="1 0.75 0"
          radius="0.3"
          height="1.5"
          color="#FFC65D"
          shadow
          animation="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true">
        </a-cylinder>

        <a-text
          value="AR World!"
          position="0 2.5 0"
          align="center"
          color="#000000"
          scale="1.5 1.5 1.5">
        </a-text>
      </a-entity>

      <!-- Câmera AR -->
      <a-entity id="rig" position="0 0 0">
        <a-camera id="camera" position="0 1.6 0"></a-camera>
      </a-entity>
    </a-scene>

    <script>
      const scene = document.querySelector('a-scene');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const errorIndicator = document.getElementById('errorIndicator');
      const startARButton = document.getElementById('startAR');
      const latEl = document.getElementById('lat');
      const lonEl = document.getElementById('lon');
      const distEl = document.getElementById('dist');
      
      let userLat = 0;
      let userLon = 0;
      let initialPosition = null;

      function showError(message) {
        errorIndicator.innerText = message;
        errorIndicator.style.display = 'block';
        setTimeout(() => {
          errorIndicator.style.display = 'none';
        }, 5000);
      }

      async function initAR() {
        if (!navigator.xr) {
          showError('WebXR não suportado neste navegador');
          return;
        }

        try {
          const supported = await navigator.xr.isSessionSupported('immersive-ar');
          if (!supported) {
            showError('AR não suportado neste dispositivo');
            return;
          }

          loadingIndicator.style.display = 'flex';
          const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['hit-test', 'local-floor'],
            optionalFeatures: ['dom-overlay'],
            domOverlay: { root: document.body }
          });

          scene.enterAR();
        } catch (err) {
          showError('Erro ao iniciar AR: ' + err);
        }
      }

      function updateLocation(position) {
        userLat = position.coords.latitude;
        userLon = position.coords.longitude;
        
        latEl.textContent = userLat.toFixed(6);
        lonEl.textContent = userLon.toFixed(6);

        if (!initialPosition) {
          initialPosition = {
            lat: userLat,
            lon: userLon
          };
        }

        const distance = calculateDistance(
          initialPosition.lat,
          initialPosition.lon,
          userLat,
          userLon
        );
        
        distEl.textContent = distance.toFixed(2);

        // Atualiza posição dos objetos baseado na distância
        const objectsEntity = document.getElementById('objects');
        const currentPosition = objectsEntity.getAttribute('position');
        objectsEntity.setAttribute('position', {
          x: currentPosition.x,
          y: currentPosition.y,
          z: -2 - (distance * 0.1) // Ajusta profundidade baseado na distância
        });
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const φ1 = lat1 * Math.PI/180;
        const φ2 = lat2 * Math.PI/180;
        const Δφ = (lat2-lat1) * Math.PI/180;
        const Δλ = (lon2-lon1) * Math.PI/180;

        const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ/2) * Math.sin(Δλ/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

        return R * c;
      }

      // Inicializa localização
      if ("geolocation" in navigator) {
        navigator.geolocation.watchPosition(updateLocation, 
          (error) => showError('Erro ao obter localização: ' + error.message),
          {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 5000
          }
        );
      }

      // Eventos
      scene.addEventListener('enter-vr', function() {
        if (scene.is('ar-mode')) {
          loadingIndicator.style.display = 'none';
          startARButton.style.display = 'none';
          document.getElementById('ground').setAttribute('visible', 'true');
        }
      });

      scene.addEventListener('exit-vr', function() {
        startARButton.style.display = 'block';
        document.getElementById('ground').setAttribute('visible', 'false');
      });

      startARButton.addEventListener('click', initAR);

      // Detecção de movimento do dispositivo
      window.addEventListener('devicemotion', (event) => {
        const objects = document.getElementById('objects');
        const acceleration = event.accelerationIncludingGravity;
        
        if (acceleration) {
          // Ajusta a posição dos objetos baseado no movimento
          const currentPos = objects.getAttribute('position');
          objects.setAttribute('position', {
            x: currentPos.x + (acceleration.x * 0.01),
            y: currentPos.y,
            z: currentPos.z + (acceleration.z * 0.01)
          });
        }
      });
    </script>
  </body>
</html>
